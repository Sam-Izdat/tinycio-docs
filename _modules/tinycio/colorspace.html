<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tinycio.colorspace &mdash; the docs</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/patch.css?v=77628c61" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b600fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/tinycio_sm.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">How to:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_hello.html">Hello Color</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_wavelength.html">Look up a wavelength</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_color_value.html">Look up a color value</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_color_space.html">Change an imageâ€™s color space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_hdr.html">Encode HDR data as RGBA PNG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_tone_map.html">Tone map HDR images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_white_balance.html">Apply white balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_ccbasic.html">Apply basic color correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_apply_lut.html">Apply LUTs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_bake_lut.html">Bake color correction to a LUT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/howto_autograde.html">Color grade by example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/example_sweeps.html">Color sweeps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/example_image_manip.html">Lower-level image manipulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/tinycio.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/ref_cs_gfx.html">Color spaces and graphics formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/about_release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/about_modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scripts:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/scripts_color2color.html">Color to color</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/scripts_hdr_codec.html">HDR Codec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/scripts_white_balance.html">White balance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/scripts_img2cube.html">Image to CUBE LUT</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Sam-Izdat/tinycio">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/tinycio/">PyPi</a></li>
<li class="toctree-l1"><a class="reference external" href="https://sam-izdat.github.io/tinycio-docs/">Docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">tinycio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tinycio.colorspace</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tinycio.colorspace</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span>

<span class="kn">from</span> <span class="nn">.numerics</span> <span class="kn">import</span> <span class="n">Float2</span><span class="p">,</span> <span class="n">matmul_tl</span> <span class="k">as</span> <span class="n">mm</span>

<div class="viewcode-block" id="ColorSpace"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.ColorSpace">[docs]</a><span class="k">class</span> <span class="nc">ColorSpace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Color space conversion. Applies OETFs and EOTFs as needed but omits tonemapping. Cylindrical transformations are </span>
<span class="sd">    treated as distinct color spaces. Example:</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">        cs_in = ColorSpace.Variant.SRGB_LIN</span>
<span class="sd">        cs_out = ColorSpace.Variant.OKLAB</span>
<span class="sd">        oklab_image = ColorSpace.convert(srgb_image, source=cs_in, destination=cs_out)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ColorSpace.Variant"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.ColorSpace.Variant">[docs]</a>    <span class="k">class</span> <span class="nc">Variant</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Color space enum. For a list of available options, see :ref:`ref_color_spaces`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">UNKNOWN</span>     <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span>  
        <span class="n">NONCOLOR</span>    <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span>  
        <span class="n">CIE_XYZ</span>     <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span>  
        <span class="n">CIE_XYY</span>     <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span>  
        <span class="n">SRGB</span>        <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span>  
        <span class="n">SRGB_LIN</span>    <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span>  
        <span class="n">REC709</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span>  
        <span class="n">REC2020</span>     <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span>  
        <span class="n">REC2020_LIN</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span>  
        <span class="n">DCI_P3</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span>  
        <span class="n">DCI_P3_LIN</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span> 
        <span class="n">DISPLAY_P3</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">11</span> 
        <span class="n">ACESCG</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span> 
        <span class="n">ACESCC</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">13</span> 
        <span class="n">ACESCCT</span>     <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span> 
        <span class="n">ACES2065_1</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span> 
        <span class="n">LMS</span>         <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span> 
        <span class="n">OKLAB</span>       <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">17</span> 
        <span class="n">CIELAB</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">18</span> 
        <span class="n">CIELUV</span>      <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">19</span> 
        <span class="n">HSV</span>         <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span> 
        <span class="n">HSL</span>         <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">21</span> 
        <span class="n">OKHSV</span>       <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">22</span>
        <span class="n">OKHSL</span>       <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">23</span>

        <span class="n">SCENE_LINEAR</span>    <span class="o">=</span> <span class="n">SRGB_LIN</span> <span class="o">|</span> <span class="n">REC2020_LIN</span> <span class="o">|</span> <span class="n">DCI_P3_LIN</span> <span class="o">|</span> <span class="n">ACESCG</span> <span class="o">|</span> <span class="n">ACES2065_1</span> <span class="o">|</span> <span class="n">LMS</span> <span class="o">|</span> <span class="n">CIE_XYZ</span>
        <span class="n">PERCEPTUAL</span>      <span class="o">=</span> <span class="n">OKLAB</span> <span class="o">|</span> <span class="n">CIELAB</span> <span class="o">|</span> <span class="n">CIELUV</span> <span class="o">|</span> <span class="n">OKHSL</span> <span class="o">|</span> <span class="n">OKHSV</span>
        <span class="n">CYLINDRICAL</span>     <span class="o">=</span> <span class="n">HSL</span> <span class="o">|</span> <span class="n">HSV</span> <span class="o">|</span> <span class="n">OKHSL</span> <span class="o">|</span> <span class="n">OKHSV</span>

        <span class="n">GAMUT_SRGB</span>      <span class="o">=</span> <span class="n">SRGB</span> <span class="o">|</span> <span class="n">SRGB_LIN</span> <span class="o">|</span> <span class="n">REC709</span> <span class="o">|</span> <span class="n">HSL</span> <span class="o">|</span> <span class="n">HSV</span>
        <span class="n">GAMUT_AP0</span>       <span class="o">=</span> <span class="n">ACES2065_1</span>
        <span class="n">GAMUT_AP1</span>       <span class="o">=</span> <span class="n">ACESCG</span> <span class="o">|</span> <span class="n">ACESCC</span> <span class="o">|</span> <span class="n">ACESCCT</span>
        <span class="n">GAMUT_REC2020</span>   <span class="o">=</span> <span class="n">REC2020</span> <span class="o">|</span> <span class="n">REC2020_LIN</span>
        <span class="n">GAMUT_DCI_P3</span>    <span class="o">=</span> <span class="n">DCI_P3</span> <span class="o">|</span> <span class="n">DCI_P3_LIN</span>
        <span class="n">GAMUT_DISPLAY_P3</span><span class="o">=</span> <span class="n">DISPLAY_P3</span>
        <span class="n">GAMUT_OKLAB</span>     <span class="o">=</span> <span class="n">OKLAB</span> <span class="o">|</span> <span class="n">OKHSL</span> <span class="o">|</span> <span class="n">OKHSV</span>
        <span class="n">GAMUT_CIE_XYZ</span>   <span class="o">=</span> <span class="n">CIE_XYZ</span> <span class="o">|</span> <span class="n">CIE_XYY</span>
        <span class="n">GAMUT_CIELAB</span>    <span class="o">=</span> <span class="n">CIELAB</span>
        <span class="n">GAMUT_CIELUV</span>    <span class="o">=</span> <span class="n">CIELUV</span>
        <span class="n">GAMUT_OTHER</span>     <span class="o">=</span> <span class="n">LMS</span> <span class="o">|</span> <span class="n">UNKNOWN</span> <span class="o">|</span> <span class="n">NONCOLOR</span>

        <span class="n">WP_D65</span>          <span class="o">=</span> <span class="n">SRGB</span> <span class="o">|</span> <span class="n">SRGB_LIN</span> <span class="o">|</span> <span class="n">REC709</span> <span class="o">|</span> <span class="n">DISPLAY_P3</span> <span class="o">|</span> <span class="n">REC2020</span> <span class="o">|</span> <span class="n">REC2020_LIN</span> <span class="o">|</span> <span class="n">CIE_XYZ</span> <span class="o">|</span> <span class="n">CIE_XYY</span>
        <span class="n">WP_CCT_6300</span>     <span class="o">=</span> <span class="n">DCI_P3</span> <span class="o">|</span> <span class="n">DCI_P3_LIN</span>
        <span class="n">WP_CCT_6000</span>     <span class="o">=</span> <span class="n">ACESCG</span> <span class="o">|</span> <span class="n">ACESCC</span> <span class="o">|</span> <span class="n">ACESCCT</span> <span class="o">|</span> <span class="n">ACES2065_1</span>

        <span class="n">MODEL_RGB</span>       <span class="o">=</span> <span class="n">SRGB</span> <span class="o">|</span> <span class="n">SRGB_LIN</span> <span class="o">|</span> <span class="n">REC709</span> <span class="o">|</span> <span class="n">REC2020</span> <span class="o">|</span> <span class="n">REC2020_LIN</span> <span class="o">|</span> <span class="n">DCI_P3</span> <span class="o">|</span> <span class="n">DCI_P3_LIN</span> <span class="o">|</span> <span class="n">DISPLAY_P3</span> <span class="o">|</span> \
                        <span class="n">ACESCG</span> <span class="o">|</span> <span class="n">ACESCC</span> <span class="o">|</span> <span class="n">ACESCCT</span> <span class="o">|</span> <span class="n">ACES2065_1</span>
        <span class="n">MODEL_CIE</span>       <span class="o">=</span> <span class="n">CIE_XYZ</span> <span class="o">|</span> <span class="n">CIE_XYY</span> <span class="o">|</span> <span class="n">CIELAB</span> <span class="o">|</span> <span class="n">CIELUV</span>
        <span class="n">MODEL_CAM</span>       <span class="o">=</span> <span class="mi">0</span>
        <span class="n">MODEL_YUV</span>       <span class="o">=</span> <span class="mi">0</span>
        <span class="n">MODEL_OTHER</span>     <span class="o">=</span> <span class="n">LMS</span> <span class="o">|</span> <span class="n">HSL</span> <span class="o">|</span> <span class="n">HSV</span> <span class="o">|</span> <span class="n">OKLAB</span> <span class="c1"># is OKLAB CAM-based?</span>
        
        <span class="n">NEGATIVE</span>        <span class="o">=</span> <span class="n">OKLAB</span> <span class="o">|</span> <span class="n">CIELAB</span> <span class="o">|</span> <span class="n">CIELUV</span> <span class="o">|</span> <span class="n">GAMUT_AP0</span>
        <span class="n">NON_NEGATIVE</span>    <span class="o">=</span> <span class="o">~</span><span class="n">NEGATIVE</span>

        <span class="n">DISABLED</span>        <span class="o">=</span> <span class="n">CIELUV</span>
        <span class="n">UNSUPPORTED</span>     <span class="o">=</span> <span class="n">OKHSV</span> <span class="o">|</span> <span class="n">OKHSL</span> <span class="c1"># disabled doesn&#39;t go here - CS must have alternate path</span>
        <span class="n">SUPPORTED</span>       <span class="o">=</span> <span class="o">~</span><span class="n">UNSUPPORTED</span> </div>

        <span class="c1"># FIXME: LUV doesn&#39;t quite match expected values, needs further testing</span>

    <span class="n">mat_xyz_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">3.24096994190452134</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.53738317757009346</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.498610760293003284</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.969243636280879826</span><span class="p">,</span> <span class="mf">1.87596750150772067</span><span class="p">,</span> <span class="mf">0.0415550574071756125</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0556300796969936084</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.203976958888976564</span><span class="p">,</span> <span class="mf">1.05697151424287856</span><span class="p">]]</span>

    <span class="n">mat_srgb_to_xyz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.412390799265959481</span><span class="p">,</span> <span class="mf">0.357584339383877964</span><span class="p">,</span> <span class="mf">0.180480788401834288</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.212639005871510358</span><span class="p">,</span> <span class="mf">0.715168678767755927</span><span class="p">,</span> <span class="mf">0.072192315360733715</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0193308187155918507</span><span class="p">,</span> <span class="mf">0.119194779794625988</span><span class="p">,</span> <span class="mf">0.950532152249660581</span><span class="p">]]</span>

    <span class="c1"># NOTE: Includes &quot;D60&quot;/D65 white point conversion</span>
    <span class="n">mat_srgb_to_acescg</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.6130974024</span><span class="p">,</span> <span class="mf">0.3395231462</span><span class="p">,</span> <span class="mf">0.04737945141</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.07019372247</span><span class="p">,</span> <span class="mf">0.916353879</span><span class="p">,</span> <span class="mf">0.01345239847</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.02061559288</span><span class="p">,</span> <span class="mf">0.1095697729</span><span class="p">,</span> <span class="mf">0.8698146341</span><span class="p">]]</span>

    <span class="c1"># NOTE: Includes &quot;D60&quot;/D65 white point conversion</span>
    <span class="n">mat_acescg_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.705050993</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.6217921206</span><span class="p">,</span><span class="o">-</span><span class="mf">0.083258872</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.1302564175</span><span class="p">,</span>  <span class="mf">1.140804737</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01054831907</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.02400335681</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1289689761</span><span class="p">,</span> <span class="mf">1.152972333</span><span class="p">]]</span>

    <span class="n">mat_aces_rrt_sat</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.970889</span><span class="p">,</span> <span class="mf">0.026963</span><span class="p">,</span> <span class="mf">0.002148</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.010889</span><span class="p">,</span> <span class="mf">0.986963</span><span class="p">,</span> <span class="mf">0.002148</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.010889</span><span class="p">,</span> <span class="mf">0.026963</span><span class="p">,</span> <span class="mf">0.962148</span><span class="p">]]</span>

    <span class="n">mat_aces_rrt_sat_inv</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.03032</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">0.0280865</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0022375</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0113427</span><span class="p">,</span>  <span class="mf">1.01358</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">0.0022375</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0113427</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0280865</span><span class="p">,</span>  <span class="mf">1.03943</span><span class="p">]]</span>

    <span class="c1"># sRGB =&gt; XYZ =&gt; D65_2_D60 =&gt; AP1 =&gt; RRT_SAT</span>
    <span class="n">mat_srgb_to_ap1_tm</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.59719</span><span class="p">,</span> <span class="mf">0.35458</span><span class="p">,</span> <span class="mf">0.04823</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.07600</span><span class="p">,</span> <span class="mf">0.90834</span><span class="p">,</span> <span class="mf">0.01566</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.02840</span><span class="p">,</span> <span class="mf">0.13383</span><span class="p">,</span> <span class="mf">0.83777</span><span class="p">]]</span>

    <span class="c1"># ODT_SAT =&gt; XYZ =&gt; D60_2_D65 =&gt; sRGB</span>
    <span class="n">mat_ap1_to_srgb_tm</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.60475</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.53108</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07367</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.10208</span><span class="p">,</span>  <span class="mf">1.10813</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00605</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.00327</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07276</span><span class="p">,</span>  <span class="mf">1.07602</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="c1"># NOTE: Includes &quot;D60&quot;/D65 white point conversion</span>
    <span class="n">mat_srgb_to_aces2065_1</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.439632982</span><span class="p">,</span>  <span class="mf">0.382988698</span><span class="p">,</span> <span class="mf">0.17737832</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0897764431</span><span class="p">,</span> <span class="mf">0.813439429</span><span class="p">,</span> <span class="mf">0.0967841284</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0175411704</span><span class="p">,</span> <span class="mf">0.111546553</span><span class="p">,</span> <span class="mf">0.870912277</span><span class="p">]]</span>

    <span class="c1"># NOTE: Includes &quot;D60&quot;/D65 white point conversion</span>
    <span class="n">mat_aces2065_1_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">2.52168619</span><span class="p">,</span>  <span class="o">-</span><span class="mf">1.13413099</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.387555198</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.276479914</span><span class="p">,</span>  <span class="mf">1.37271909</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0962391736</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.015378065</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.152975336</span><span class="p">,</span> <span class="mf">1.1683534</span><span class="p">]]</span>

    <span class="n">mat_srgb_to_displayp3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.822461969</span><span class="p">,</span>  <span class="mf">0.177538031</span><span class="p">,</span>  <span class="mf">1.15772692e-10</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0331941989</span><span class="p">,</span> <span class="mf">0.966805801</span><span class="p">,</span>  <span class="mf">1.95085037e-11</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0170826307</span><span class="p">,</span> <span class="mf">0.0723974405</span><span class="p">,</span> <span class="mf">0.910519929</span><span class="p">]]</span>

    <span class="n">mat_displayp3_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.22494018</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.224940176</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.77534979e-11</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0420569547</span><span class="p">,</span> <span class="mf">1.04205695</span><span class="p">,</span>   <span class="mf">3.37864801e-11</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0196375546</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0786360454</span><span class="p">,</span> <span class="mf">1.0982736</span><span class="p">]]</span> 

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_srgb_to_dcip3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.868579739716132409</span><span class="p">,</span>  <span class="mf">0.128919138460847047</span><span class="p">,</span>  <span class="mf">0.00250112182302054368</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0345404102543194426</span><span class="p">,</span> <span class="mf">0.961811386361919975</span><span class="p">,</span>  <span class="mf">0.0036482033837605824</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0167714290414502718</span><span class="p">,</span> <span class="mf">0.0710399977868858352</span><span class="p">,</span> <span class="mf">0.912188573171663893</span><span class="p">]]</span>

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_dcip3_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.15751640619975871</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.154962378073857756</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00255402812590095854</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0415000715306859699</span><span class="p">,</span> <span class="mf">1.04556792307969925</span><span class="p">,</span>  <span class="o">-</span><span class="mf">0.00406785154901328463</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0180500389562539583</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0785782726530290654</span><span class="p">,</span> <span class="mf">1.09662831160928302</span><span class="p">]]</span>

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_dcip3_to_xyz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.445169815564552417</span><span class="p">,</span>    <span class="mf">0.277134409206777664</span><span class="p">,</span>  <span class="mf">0.172282669815564564</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.209491677912730539</span><span class="p">,</span>    <span class="mf">0.721595254161043636</span><span class="p">,</span>  <span class="mf">0.0689130679262258258</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">3.63410131696985616e-17</span><span class="p">,</span> <span class="mf">0.0470605600539811521</span><span class="p">,</span> <span class="mf">0.907355394361973415</span><span class="p">]]</span>

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_xyz_to_dcip3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">2.7253940304917328</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.01800300622718496</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.440163195190036463</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.795168025808764195</span><span class="p">,</span> <span class="mf">1.689732054843624</span><span class="p">,</span> <span class="mf">0.0226471906084774533</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0412418913957000325</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0876390192158623825</span><span class="p">,</span> <span class="mf">1.10092937864632191</span><span class="p">]]</span>

    <span class="n">mat_srgb_to_rec2020</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.627403896</span><span class="p">,</span>  <span class="mf">0.329283039</span><span class="p">,</span>  <span class="mf">0.0433130657</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0690972894</span><span class="p">,</span> <span class="mf">0.919540395</span><span class="p">,</span>  <span class="mf">0.0113623156</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0163914389</span><span class="p">,</span> <span class="mf">0.0880133077</span><span class="p">,</span> <span class="mf">0.895595253</span><span class="p">]]</span>

    <span class="n">mat_rec2020_to_srgb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.660491</span><span class="p">,</span>    <span class="o">-</span><span class="mf">0.587641139</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0728498633</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.124550475</span><span class="p">,</span> <span class="mf">1.1328999</span><span class="p">,</span>   <span class="o">-</span><span class="mf">0.00834942258</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0181507633</span><span class="p">,</span><span class="o">-</span><span class="mf">0.100578898</span><span class="p">,</span> <span class="mf">1.11872966</span><span class="p">]]</span>

    <span class="n">mat_rec2020_to_xyz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.636958048301291</span><span class="p">,</span> <span class="mf">0.144616903586208</span><span class="p">,</span> <span class="mf">0.168880975164172</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.262700212011267</span><span class="p">,</span> <span class="mf">0.677998071518871</span><span class="p">,</span> <span class="mf">0.059301716469862</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">4.99410657446607e-17</span><span class="p">,</span> <span class="mf">0.0280726930490874</span><span class="p">,</span> <span class="mf">1.06098505771079</span><span class="p">]]</span>

    <span class="n">mat_xyz_to_rec2020</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">1.71665118797127</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.355670783776393</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25336628137366</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.666684351832489</span><span class="p">,</span> <span class="mf">1.61648123663494</span><span class="p">,</span> <span class="mf">0.0157685458139111</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0176398574453108</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0427706132578085</span><span class="p">,</span> <span class="mf">0.942103121235474</span><span class="p">]]</span>

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_acescg_to_xyz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.66245418</span><span class="p">,</span> <span class="mf">0.13400421</span><span class="p">,</span> <span class="mf">0.15618769</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.27222872</span><span class="p">,</span> <span class="mf">0.67408177</span><span class="p">,</span> <span class="mf">0.05368952</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.00557465</span><span class="p">,</span> <span class="mf">0.00406073</span><span class="p">,</span> <span class="mf">1.0103391</span> <span class="p">]]</span>

    <span class="c1"># NOTE: No chromatic adaptation</span>
    <span class="n">mat_xyz_to_acescg</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.64102338</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.32480329</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2364247</span> <span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.66366286</span><span class="p">,</span>  <span class="mf">1.61533159</span><span class="p">,</span>  <span class="mf">0.01675635</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.01172189</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00828444</span><span class="p">,</span>  <span class="mf">0.98839486</span><span class="p">]]</span>

    <span class="c1"># NOTE: For CIE XYZ color</span>
    <span class="n">mat_d60_to_d65</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.98722400</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00611327</span><span class="p">,</span> <span class="mf">0.01595330</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.00759836</span><span class="p">,</span> <span class="mf">1.00186000</span><span class="p">,</span> <span class="mf">0.00533002</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.00307257</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00509595</span><span class="p">,</span> <span class="mf">1.08168000</span><span class="p">]]</span>

    <span class="c1"># NOTE: For CIE XYZ color</span>
    <span class="n">mat_d65_to_d60</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.01303000</span><span class="p">,</span> <span class="mf">0.00610531</span><span class="p">,</span><span class="o">-</span><span class="mf">0.01497100</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.00769823</span><span class="p">,</span> <span class="mf">0.99816500</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00503203</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.00284131</span><span class="p">,</span> <span class="mf">0.00468516</span><span class="p">,</span> <span class="mf">0.92450700</span><span class="p">]]</span>

    <span class="c1"># NOTE: For CIE XYZ color</span>
    <span class="n">mat_d65_to_dci</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.976578896646979768</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0154362646984919742</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.016686021704209866</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.0256896658505145926</span><span class="p">,</span> <span class="mf">1.02853916787996963</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00378517365630504153</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.00570574587417104179</span><span class="p">,</span> <span class="mf">0.0110778657389971485</span><span class="p">,</span> <span class="mf">0.871176159390377409</span><span class="p">]]</span>
    
    <span class="c1"># NOTE: For CIE XYZ color</span>
    <span class="n">mat_dci_to_d65</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">1.02449672775257752</span><span class="p">,</span> <span class="mf">0.0151635410224165156</span><span class="p">,</span> <span class="mf">0.0196885223342066827</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0256121933371584198</span><span class="p">,</span> <span class="mf">0.97258630562441342</span><span class="p">,</span> <span class="mf">0.00471635229242730096</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0063842306500876874</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.012268082736730219</span><span class="p">,</span> <span class="mf">1.14794244517367791</span><span class="p">]]</span>

    <span class="n">mat_xyz_to_lms</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.8951</span><span class="p">,</span> <span class="mf">0.2664</span><span class="p">,</span><span class="o">-</span><span class="mf">0.1614</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.7502</span><span class="p">,</span> <span class="mf">1.7135</span><span class="p">,</span> <span class="mf">0.0367</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0389</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0685</span><span class="p">,</span> <span class="mf">1.0296</span><span class="p">]]</span>

    <span class="n">mat_lms_to_xyz</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.986993</span><span class="p">,</span>   <span class="o">-</span><span class="mf">0.147054</span><span class="p">,</span>  <span class="mf">0.159963</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.432305</span><span class="p">,</span>    <span class="mf">0.51836</span><span class="p">,</span>   <span class="mf">0.0492912</span><span class="p">],</span>
        <span class="p">[</span> <span class="o">-</span><span class="mf">0.00852866</span><span class="p">,</span> <span class="mf">0.0400428</span><span class="p">,</span> <span class="mf">0.968487</span><span class="p">]]</span>

    <span class="c1"># OKLAB&#39;s XYZ to LMS</span>
    <span class="n">mat_oklab_m1</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.8189330101</span><span class="p">,</span>  <span class="mf">0.3618667424</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1288597137</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0329845436</span><span class="p">,</span>  <span class="mf">0.9293118715</span><span class="p">,</span>  <span class="mf">0.0361456387</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0482003018</span><span class="p">,</span>  <span class="mf">0.2643662691</span><span class="p">,</span>  <span class="mf">0.6338517070</span><span class="p">]]</span>

    <span class="c1"># OKLAB&#39;s non-linear L&#39;M&#39;S&#39; to OKLAB</span>
    <span class="n">mat_oklab_m2</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">0.2104542553</span><span class="p">,</span>  <span class="mf">0.7936177850</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0040720468</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.9779984951</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.4285922050</span><span class="p">,</span>  <span class="mf">0.4505937099</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.0259040371</span><span class="p">,</span>  <span class="mf">0.7827717662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8086757660</span><span class="p">]]</span>

    <span class="c1"># Inverse of OKLAB M1</span>
    <span class="n">mat_oklab_m1_inv</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.22701385</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.55779998</span><span class="p">,</span>  <span class="mf">0.28125615</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.04058018</span><span class="p">,</span>  <span class="mf">1.11225687</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07167668</span><span class="p">],</span>
        <span class="p">[</span><span class="o">-</span><span class="mf">0.07638128</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.42148198</span><span class="p">,</span>  <span class="mf">1.58616322</span><span class="p">]]</span>

    <span class="c1"># Inverse of OKLAB M2</span>
    <span class="n">mat_oklab_m2_inv</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span> <span class="mf">1.</span>        <span class="p">,</span>  <span class="mf">0.39633779</span><span class="p">,</span>  <span class="mf">0.21580376</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.00000001</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10556134</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06385417</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">1.00000005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08948418</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.29148554</span><span class="p">]]</span>

<div class="viewcode-block" id="ColorSpace.convert"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.ColorSpace.convert">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ColorImage</span><span class="p">],</span> <span class="n">source</span><span class="p">:</span><span class="n">Variant</span><span class="p">,</span> <span class="n">destination</span><span class="p">:</span><span class="n">Variant</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the color space of an image. Cylindrical transformations HSV/HSL are </span>
<span class="sd">        treated as their own color spaces and assumed to be relative to sRGB linear. </span>
<span class="sd">        Unless otherwise noted or required by specification (e.g. ACES), we assume D65 white point.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Tone mapping is not automatically included. Thus, converting a wide-gamut color space to one </span>
<span class="sd">            with a narrower gamut, or converting HDR values to a nominally LDR-designated color space </span>
<span class="sd">            will not automatically remap out-of-gamut color to in-gamut or reduce dynamic range. </span>
<span class="sd">            It will likely yield out-of-gamut (positive of negative) or out-of-range values. </span>
<span class="sd">            These values should still, at some point, be tone mapped or clamped to the desired output range.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Cylindrical transformations (HSL, HSV) should be given input in [0, 1] linear sRGB range </span>
<span class="sd">            (or equivalent). This is not strictly enforced but input outside this range may yield </span>
<span class="sd">            unpredictable results or *NaN* values.</span>

<span class="sd">        :param im: [C=3, H, W] image tensor </span>
<span class="sd">        :type im: torch.Tensor | ColorImage</span>
<span class="sd">        :param source: color space to convert from</span>
<span class="sd">        :param destination: color space to convert to</span>
<span class="sd">        :return: image tensor in designated color space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ip</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Variant</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">TransferFunction</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">op</span><span class="p">:</span> <span class="k">return</span> <span class="n">im</span>

        <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;expected [C=3, H, W] image tensor, got </span><span class="si">{</span><span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="n">source</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>             <span class="sa">f</span><span class="s2">&quot;Unknown source color space&quot;</span>
        <span class="k">assert</span> <span class="n">ip</span> <span class="o">&amp;</span> <span class="n">cs</span><span class="o">.</span><span class="n">SUPPORTED</span><span class="p">,</span>       <span class="sa">f</span><span class="s2">&quot;Source color space not supported: </span><span class="si">{</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="n">cs</span><span class="o">.</span><span class="n">SUPPORTED</span><span class="p">,</span>       <span class="sa">f</span><span class="s2">&quot;Destination color space not supported: </span><span class="si">{</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="n">ip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cs</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">,</span>       <span class="sa">f</span><span class="s2">&quot;Source color space disabled: </span><span class="si">{</span><span class="n">ColorSpace</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">assert</span> <span class="n">op</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">cs</span><span class="o">.</span><span class="n">DISABLED</span><span class="p">,</span>       <span class="sa">f</span><span class="s2">&quot;Destination color space disabled: </span><span class="si">{</span><span class="n">ColorSpace</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">err_not_implemented</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Color space conversion not implemented: </span><span class="si">{</span><span class="n">ColorSpace</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">ColorSpace</span><span class="o">.</span><span class="n">Variant</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> 

        <span class="c1"># Direct path where it matters, loop-de-loop elsewhere</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB</span><span class="p">:</span>         <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">srgb_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC709</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">rec709_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">rec2020_oetf</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_rec2020</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020_LIN</span><span class="p">:</span>  <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_rec2020</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">dcip3_oetf</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d65_to_dci</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_dcip3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3_LIN</span><span class="p">:</span>   <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d65_to_dci</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_dcip3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DISPLAY_P3</span><span class="p">:</span>   <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">srgb_oetf</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_displayp3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYY</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_xyy</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">LMS</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_lms</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCG</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_acescg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCC</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_acescg_to_acescc</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_acescg</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACES2065_1</span><span class="p">:</span>   <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_aces2065_1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELAB</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_cielab</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELUV</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_cieluv</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_srgb_to_xyz</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">OKLAB</span><span class="p">:</span>        <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rgb_to_oklab</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSL</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rgb_to_hsl</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSV</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rgb_to_hsv</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err_not_implemented</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSL</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rgb_to_hsl</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSV</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rgb_to_hsv</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC709</span><span class="p">:</span>           <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">rec709_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020</span><span class="p">:</span>          
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020_LIN</span><span class="p">:</span>    <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">rec2020_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">rec2020_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_xyz</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">:</span>     <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">rec2020_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_srgb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">rec2020_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020_LIN</span><span class="p">:</span>      
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020</span><span class="p">:</span>        <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">rec2020_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_xyz</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">:</span>     <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_srgb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_rec2020_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3</span><span class="p">:</span>           
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3_LIN</span><span class="p">:</span>     <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">dcip3_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">dcip3_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dcip3_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dci_to_d65</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">dcip3_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dcip3_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dci_to_d65</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3_LIN</span><span class="p">:</span>       
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3</span><span class="p">:</span>         <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">dcip3_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dcip3_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dci_to_d65</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dcip3_to_xyz</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_dci_to_d65</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DISPLAY_P3</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_displayp3_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYY</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_xyy</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020_LIN</span><span class="p">:</span>  <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_rec2020</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">REC2020</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">rec2020_oetf</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_rec2020</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3_LIN</span><span class="p">:</span>   <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d65_to_dci</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_dcip3</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">DCI_P3</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">dcip3_oetf</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d65_to_dci</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_dcip3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">LMS</span><span class="p">:</span>          <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_lms</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCG</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_d65_to_d60</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_acescg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELAB</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_cielab</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELUV</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_cieluv</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">OKLAB</span><span class="p">:</span>        <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyz_to_oklab</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYY</span><span class="p">:</span>          
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_xyy_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_xyy_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">LMS</span><span class="p">:</span>              
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lms_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_lms_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCG</span><span class="p">:</span>
            <span class="c1"># if   op == cs.CIE_XYZ:      im = cls._d60_to_d65(mm(im, cls.mat_acescg_to_xyz)) # FIXME: fails unit test (?)</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCC</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_acescg_to_acescc</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_acescg_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCC</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCG</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_acescc_to_acescg</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_acescc_to_acescg</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACESCG</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">ACES2065_1</span><span class="p">:</span>       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_aces2065_1_to_srgb</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSL</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB</span><span class="p">:</span>         <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_hsl_to_rgb</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_eotf</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_hsl_to_rgb</span><span class="p">(</span><span class="n">im</span><span class="p">)),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">HSV</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB</span><span class="p">:</span>         <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_hsv_to_rgb</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">srgb_eotf</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_hsv_to_rgb</span><span class="p">(</span><span class="n">im</span><span class="p">)),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELAB</span><span class="p">:</span>           <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cielab_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIELUV</span><span class="p">:</span>           <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cieluv_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ip</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">OKLAB</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">op</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">CIE_XYZ</span><span class="p">:</span>      <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_oklab_to_xyz</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">im</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_oklab_to_rgb</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="n">cs</span><span class="o">.</span><span class="n">SRGB_LIN</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err_not_implemented</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_xyz_to_xyy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyz</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE XYZ color space to CIE xyY color space.</span>

<span class="sd">        :param xyz: Input CIE XYZ color space tensor</span>
<span class="sd">        :return: CIE xyY color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">X</span> <span class="o">/</span> <span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">Z</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">/</span> <span class="p">(</span><span class="n">X</span> <span class="o">+</span> <span class="n">Y</span> <span class="o">+</span> <span class="n">Z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_xyy_to_xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyy</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE xyY color space to CIE XYZ color space.</span>

<span class="sd">        :param xyy: Input CIE xyY color space tensor</span>
<span class="sd">        :return: CIE XYZ color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-7</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xyy</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">xyy</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">xyy</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">y</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_ap1_rrt_sat</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_aces_rrt_sat</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_ap1_rrt_sat_inv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_aces_rrt_sat_inv</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_xyz_to_lms</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyz</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE XYZ color space to LMS color space.</span>

<span class="sd">        :param xyz: Input CIE XYZ color space tensor</span>
<span class="sd">        :return: LMS color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_xyz_to_lms</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_lms_to_xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lms</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert LMS color space to CIE XYZ color space.</span>

<span class="sd">        :param lms: Input LMS color space tensor</span>
<span class="sd">        :return: CIE XYZ color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">lms</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_lms_to_xyz</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_acescg_to_acescc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cg</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert scene-linear ACEScg to log ACEScc.</span>

<span class="sd">        :param lms: Input ACEScg color space tensor</span>
<span class="sd">        :return: ACEScc color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cg</span> <span class="o">&lt;</span> <span class="mf">0.00003051757</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mf">0.00001525878</span> <span class="o">+</span> <span class="n">cg</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">9.72</span><span class="p">)</span> <span class="o">/</span> <span class="mf">17.52</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">cg</span><span class="p">)</span> <span class="o">+</span> <span class="mf">9.72</span><span class="p">)</span> <span class="o">/</span> <span class="mf">17.52</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_acescc_to_acescg</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cc</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert log ACEScc to scene-linear ACEScg.</span>

<span class="sd">        :param lms: Input ACEScc color space tensor</span>
<span class="sd">        :return: ACEScg color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cc</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.3013698630</span><span class="p">,</span> 
            <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">cc</span> <span class="o">*</span> <span class="mf">17.52</span> <span class="o">-</span> <span class="mf">9.72</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.00001525878</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">exp2</span><span class="p">(</span><span class="n">cc</span> <span class="o">*</span> <span class="mf">17.52</span> <span class="o">-</span> <span class="mf">9.72</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_xyz_to_oklab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyz</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE XYZ color space to OKLAB color space.</span>

<span class="sd">        :param xyz: Input CIE XYZ color space tensor</span>
<span class="sd">        :return: OKLAB color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="n">lms</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_oklab_m1</span><span class="p">)</span>
        <span class="n">lms_p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lms</span><span class="p">),</span> <span class="mf">0.3333333333</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">lms</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">lms_p</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_oklab_m2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lab</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_oklab_to_xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lab</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert OKLAB color space to CIE XYZ color space.</span>

<span class="sd">        :param lab: Input OKLAB color space tensor</span>
<span class="sd">        :return: CIE XYZ color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lms_p</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">lab</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_oklab_m2_inv</span><span class="p">)</span>
        <span class="n">lms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">lms_p</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">mm</span><span class="p">(</span><span class="n">lms</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_oklab_m1_inv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__pivot_xyz_to_lab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>        
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.008856</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mf">0.3333333333</span><span class="p">),</span> <span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="mf">903.3</span><span class="p">)</span> <span class="o">+</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">116.0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_xyz_to_cielab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">xyz</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert color space from CIE XYZ to CIELAB.</span>

<span class="sd">        :param xyz: Input CIE XYZ color space tensor</span>
<span class="sd">        :return: CIELAB color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/CairX/convert-colors-py/blob/master/convcolors/__init__.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 Thomas Cairns</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.        </span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.95047</span> 
        <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.00000</span> 
        <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.08883</span> 

        <span class="n">x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__pivot_xyz_to_lab</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__pivot_xyz_to_lab</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__pivot_xyz_to_lab</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="p">(</span><span class="mf">116.0</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mf">16.0</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">500.0</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="mf">200.0</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">l</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_cielab_to_xyz</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lab</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert color space from CIELAB to CIE XYZ.</span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            Assumes D65 standard illuminant.</span>

<span class="sd">        :param lab: Input CIELAB color space tensor</span>
<span class="sd">        :return: CIE XYZ color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/CairX/convert-colors-py/blob/master/convcolors/__init__.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 Thomas Cairns</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Reminder: The y values is calculated first as it can be reused</span>
        <span class="c1"># for the calculation of x and z.</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">116.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">/</span> <span class="mf">500.0</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="mf">200.0</span><span class="p">)</span>

        <span class="n">x3</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
        <span class="n">z3</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span>
        <span class="n">y3</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x3</span> <span class="o">&gt;</span> <span class="mf">0.008856</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="p">((</span><span class="n">x</span> <span class="o">*</span> <span class="mf">116.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">903.3</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mf">7.9996248</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">l</span> <span class="o">/</span> <span class="mf">903.3</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z3</span> <span class="o">&gt;</span> <span class="mf">0.008856</span><span class="p">,</span> <span class="n">z3</span><span class="p">,</span> <span class="p">((</span><span class="n">z</span> <span class="o">*</span> <span class="mf">116.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">903.3</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">0.95047</span> 
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="mf">1.00000</span> 
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="mf">1.08883</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_xyz_to_cieluv</span><span class="p">(</span><span class="n">image</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts CIE XYZ to CIELUV. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            Assumes D65 standard illuminant.</span>

<span class="sd">        :param image: A pytorch tensor of shape (3, n_pixels_x, n_pixels_y) in which the channels are X, Y, Z</span>
<span class="sd">        :return: A pytorch tensor of shape (3, n_pixels_x, n_pixels_y) in which the channels are L, U, V</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/stefanLeong/S2CRNet/blob/main/scripts/utils/color.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2021 StefanLeong</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">small_L</span> <span class="o">=</span> <span class="p">(</span><span class="mf">29.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">large_L</span> <span class="o">=</span> <span class="mi">116</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="mi">29</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="n">small_L</span><span class="p">,</span> <span class="n">large_L</span><span class="p">)</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">u_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">v_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">small_L</span> <span class="o">=</span> <span class="p">(</span><span class="mf">29.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">large_L</span> <span class="o">=</span> <span class="mi">116</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span>
            <span class="n">L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mf">6.</span> <span class="o">/</span> <span class="mi">29</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="n">small_L</span><span class="p">,</span> <span class="n">large_L</span><span class="p">)</span>

            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">u_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">v_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">u</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="n">u_prime</span> <span class="o">-</span> <span class="mf">.2009</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_prime</span> <span class="o">-</span> <span class="mf">.4610</span><span class="p">)</span>

        <span class="n">luv_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">L</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">luv_image</span>

    <span class="k">def</span> <span class="nf">_cieluv_to_xyz</span><span class="p">(</span><span class="n">image</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts CIELUV to CIE XYZ. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            Assumes D65 standard illuminant.</span>

<span class="sd">        :param image: A pytorch tensor of shape (3, n_pixels_x, n_pixels_y) in which the channels are L, U, V</span>
<span class="sd">        :return: A pytorch tensor of shape (3, n_pixels_x, n_pixels_y) in which the channels are X, Y, Z</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/stefanLeong/S2CRNet/blob/main/scripts/utils/color.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2021 StefanLeong</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">u_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span> <span class="mf">.2009</span>
            <span class="n">v_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span> <span class="mf">.4610</span>

            <span class="n">small_Y</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">29</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
            <span class="n">large_Y</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">16.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">116.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>

            <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">small_Y</span><span class="p">,</span> <span class="n">large_Y</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># batch of images</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">u_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span> <span class="mf">.2009</span>
            <span class="n">v_prime</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span> <span class="mf">.4610</span>

            <span class="n">small_Y</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mi">29</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>
            <span class="n">large_Y</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">16.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">116.</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span>

            <span class="n">Y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">small_Y</span><span class="p">,</span> <span class="n">large_Y</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_prime</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">Y</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">*</span> <span class="n">u_prime</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">v_prime</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_prime</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">12</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u_prime</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">v_prime</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">v_prime</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="n">xyz_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xyz_image</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rgb_to_oklab</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rgb</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert color space from linear sRGB to OKLAB.</span>

<span class="sd">        :param rgb: Input linear sRGB color space tensor</span>
<span class="sd">        :return: OKLAB color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cg</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">l</span> <span class="o">=</span> <span class="mf">0.4122214708</span> <span class="o">*</span> <span class="n">cr</span> <span class="o">+</span> <span class="mf">0.5363325363</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">+</span> <span class="mf">0.0514459929</span> <span class="o">*</span> <span class="n">cb</span><span class="p">;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mf">0.2119034982</span> <span class="o">*</span> <span class="n">cr</span> <span class="o">+</span> <span class="mf">0.6806995451</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">+</span> <span class="mf">0.1073969566</span> <span class="o">*</span> <span class="n">cb</span><span class="p">;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0883024619</span> <span class="o">*</span> <span class="n">cr</span> <span class="o">+</span> <span class="mf">0.2817188376</span> <span class="o">*</span> <span class="n">cg</span> <span class="o">+</span> <span class="mf">0.6299787005</span> <span class="o">*</span> <span class="n">cb</span><span class="p">;</span>

        <span class="n">l_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="mf">0.3333333333</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">m_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="mf">0.3333333333</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">s_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mf">0.3333333333</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
            <span class="mf">0.2104542553</span> <span class="o">*</span> <span class="n">l_</span> <span class="o">+</span> <span class="mf">0.7936177850</span> <span class="o">*</span> <span class="n">m_</span> <span class="o">-</span> <span class="mf">0.0040720468</span> <span class="o">*</span> <span class="n">s_</span><span class="p">,</span>
            <span class="mf">1.9779984951</span> <span class="o">*</span> <span class="n">l_</span> <span class="o">-</span> <span class="mf">2.4285922050</span> <span class="o">*</span> <span class="n">m_</span> <span class="o">+</span> <span class="mf">0.4505937099</span> <span class="o">*</span> <span class="n">s_</span><span class="p">,</span>
            <span class="mf">0.0259040371</span> <span class="o">*</span> <span class="n">l_</span> <span class="o">+</span> <span class="mf">0.7827717662</span> <span class="o">*</span> <span class="n">m_</span> <span class="o">-</span> <span class="mf">0.8086757660</span> <span class="o">*</span> <span class="n">s_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_oklab_to_rgb</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lab</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert color space from OKLAB to linear sRGB.</span>

<span class="sd">        :param lab: Input OKLAB color space tensor</span>
<span class="sd">        :return: Linear sRGB color space tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ca</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">lab</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">l_</span> <span class="o">=</span> <span class="n">cl</span> <span class="o">+</span> <span class="mf">0.3963377774</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">+</span> <span class="mf">0.2158037573</span> <span class="o">*</span> <span class="n">cb</span>
        <span class="n">m_</span> <span class="o">=</span> <span class="n">cl</span> <span class="o">-</span> <span class="mf">0.1055613458</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">-</span> <span class="mf">0.0638541728</span> <span class="o">*</span> <span class="n">cb</span>
        <span class="n">s_</span> <span class="o">=</span> <span class="n">cl</span> <span class="o">-</span> <span class="mf">0.0894841775</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">-</span> <span class="mf">1.2914855480</span> <span class="o">*</span> <span class="n">cb</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">l_</span><span class="o">*</span><span class="n">l_</span><span class="o">*</span><span class="n">l_</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m_</span><span class="o">*</span><span class="n">m_</span><span class="o">*</span><span class="n">m_</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s_</span><span class="o">*</span><span class="n">s_</span><span class="o">*</span><span class="n">s_</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
            <span class="o">+</span><span class="mf">4.0767416621</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="mf">3.3077115913</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="mf">0.2309699292</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">1.2684380046</span> <span class="o">*</span> <span class="n">l</span> <span class="o">+</span> <span class="mf">2.6097574011</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mf">0.3413193965</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span>
            <span class="o">-</span><span class="mf">0.0041960863</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="mf">0.7034186147</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="mf">1.7076147010</span> <span class="o">*</span> <span class="n">s</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rgb_to_hsl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rgb</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform sRGB image tensor to sRGB-relative HSL. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            expects non-linear sRGB w/ gamma curve as input</span>

<span class="sd">        :param rgb: Input sRGB image tensor</span>
<span class="sd">        :return: HSL image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/windingwind/seal-3d/blob/main/SealNeRF/color_utils.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 hawkey</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cmax</span><span class="p">,</span> <span class="n">cmax_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span>
        <span class="n">hsl_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">cmax_idx</span><span class="p">[</span><span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">hsl_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">hsl_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">hsl_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">hsl_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">hsl_h</span> <span class="o">/=</span> <span class="mf">6.</span>

        <span class="n">hsl_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmax</span> <span class="o">+</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">hsl_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">hsl_h</span><span class="p">)</span>
        <span class="n">hsl_s</span><span class="p">[</span><span class="n">hsl_l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hsl_s</span><span class="p">[</span><span class="n">hsl_l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hsl_l_ma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">hsl_l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsl_l</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hsl_l_s0_5</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">hsl_l_ma</span><span class="p">,</span> <span class="n">hsl_l</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">hsl_l_l0_5</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">hsl_l_ma</span><span class="p">,</span> <span class="n">hsl_l</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">hsl_s</span><span class="p">[</span><span class="n">hsl_l_s0_5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hsl_l</span> <span class="o">*</span> <span class="mf">2.</span><span class="p">))[</span><span class="n">hsl_l_s0_5</span><span class="p">]</span>
        <span class="n">hsl_s</span><span class="p">[</span><span class="n">hsl_l_l0_5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span> <span class="n">hsl_l</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">+</span> <span class="mf">2.</span><span class="p">))[</span><span class="n">hsl_l_l0_5</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hsl_h</span><span class="p">,</span> <span class="n">hsl_s</span><span class="p">,</span> <span class="n">hsl_l</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hsl_to_rgb</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hsl</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform sRGB-relative HSL image tensor to sRGB. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            returns non-linear sRGB w/ gamma curve as output</span>

<span class="sd">        :param hsl: Input HSL image tensor</span>
<span class="sd">        :return: sRGB image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/windingwind/seal-3d/blob/main/SealNeRF/color_utils.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 hawkey</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="n">hsl</span> <span class="o">=</span> <span class="n">hsl</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hsl_h</span><span class="p">,</span> <span class="n">hsl_s</span><span class="p">,</span> <span class="n">hsl_l</span> <span class="o">=</span> <span class="n">hsl</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">hsl</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hsl</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hsl_l</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">hsl_s</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">_c</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hsl_h</span> <span class="o">*</span> <span class="mf">6.</span> <span class="o">%</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">_m</span> <span class="o">=</span> <span class="n">hsl_l</span> <span class="o">-</span> <span class="n">_c</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsl_h</span> <span class="o">*</span> <span class="mf">6.</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">hsl</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hsl</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">_o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">_c</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hsl</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_c</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_o</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_o</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_o</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_o</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_o</span><span class="p">,</span> <span class="n">_c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_c</span><span class="p">,</span> <span class="n">_o</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">rgb</span> <span class="o">+=</span> <span class="n">_m</span>
        <span class="k">return</span> <span class="n">rgb</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rgb_to_hsv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rgb</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform sRGB image tensor to sRGB-relative HSV. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>

<span class="sd">            expects non-linear sRGB w/ gamma curve as input</span>

<span class="sd">        .. warning::</span>

<span class="sd">            input tensor will be clamped to [0, 1] range</span>

<span class="sd">        :param rgb: Input sRGB image tensor</span>
<span class="sd">        :return: HSV image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/windingwind/seal-3d/blob/main/SealNeRF/color_utils.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 hawkey</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">rgb</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cmax</span><span class="p">,</span> <span class="n">cmax_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">cmax</span> <span class="o">-</span> <span class="n">cmin</span>
        <span class="n">hsv_h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">cmax_idx</span><span class="p">[</span><span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">hsv_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">hsv_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">hsv_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rgb</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rgb</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">hsv_h</span><span class="p">[</span><span class="n">cmax_idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">hsv_h</span> <span class="o">/=</span> <span class="mf">6.</span>
        <span class="n">hsv_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cmax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">rgb</span><span class="p">),</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">cmax</span><span class="p">)</span>
        <span class="n">hsv_v</span> <span class="o">=</span> <span class="n">cmax</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hsv_h</span><span class="p">,</span> <span class="n">hsv_s</span><span class="p">,</span> <span class="n">hsv_v</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_hsv_to_rgb</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hsv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform sRGB-relative HSV image tensor to sRGB. </span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>
<span class="sd">        </span>
<span class="sd">            returns non-linear sRGB w/ gamma curve as output</span>

<span class="sd">        :param hsv: Input HSV image tensor</span>
<span class="sd">        :return: sRGB image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://github.com/windingwind/seal-3d/blob/main/SealNeRF/color_utils.py</span>
        <span class="c1"># MIT License</span>

        <span class="c1"># Copyright (c) 2022 hawkey</span>

        <span class="c1"># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
        <span class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
        <span class="c1"># in the Software without restriction, including without limitation the rights</span>
        <span class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
        <span class="c1"># copies of the Software, and to permit persons to whom the Software is</span>
        <span class="c1"># furnished to do so, subject to the following conditions:</span>

        <span class="c1"># The above copyright notice and this permission notice shall be included in all</span>
        <span class="c1"># copies or substantial portions of the Software.</span>

        <span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
        <span class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
        <span class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
        <span class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
        <span class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
        <span class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
        <span class="c1"># SOFTWARE.</span>
        <span class="n">hsv</span> <span class="o">=</span> <span class="n">hsv</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hsv_h</span><span class="p">,</span> <span class="n">hsv_s</span><span class="p">,</span> <span class="n">hsv_l</span> <span class="o">=</span> <span class="n">hsv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">hsv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">hsv</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="n">hsv_l</span> <span class="o">*</span> <span class="n">hsv_s</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">_c</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">hsv_h</span> <span class="o">*</span> <span class="mf">6.</span> <span class="o">%</span> <span class="mf">2.</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">_m</span> <span class="o">=</span> <span class="n">hsv_l</span> <span class="o">-</span> <span class="n">_c</span>
        <span class="n">_o</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">_c</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hsv</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsv_h</span> <span class="o">*</span> <span class="mf">6.</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">hsv</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hsv</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_c</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_o</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_o</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_o</span><span class="p">,</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_o</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_x</span><span class="p">,</span> <span class="n">_o</span><span class="p">,</span> <span class="n">_c</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">rgb</span><span class="p">[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">_c</span><span class="p">,</span> <span class="n">_o</span><span class="p">,</span> <span class="n">_x</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">rgb</span> <span class="o">+=</span> <span class="n">_m</span>
        <span class="k">return</span> <span class="n">rgb</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_d60_to_d65</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE XYZ image from &quot;D60&quot; to D65 white point.</span>

<span class="sd">        :param im: Input image tensor</span>
<span class="sd">        :return: Converted image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># There is not really a CIE D60 white point, but that&#39;s what everyone calls what ACES uses.</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d60_to_d65</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_d65_to_d60</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert CIE XYZ image from D65 to &quot;D60&quot; white point.</span>

<span class="sd">        :param torch.Tensor im: Input image tensor</span>
<span class="sd">        :return: Converted image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mm</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mat_d65_to_d60</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction">[docs]</a><span class="k">class</span> <span class="nc">TransferFunction</span><span class="p">:</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opto-electronic/electro-optical transfer functions. Example:</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">        im_srgb = TransferFunction.srgb_oetf(im_linear)</span>

<span class="sd">    .. note::</span>

<span class="sd">        These transfer functions are applied automatically by :code:`ColorSpace.convert` when appropriate, </span>
<span class="sd">        but can instead be used explicitly.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Out-of-gamut values will be accepted, but the values returned may not be well-defined </span>
<span class="sd">        or meaningful. The goal is only to keep them consistent and out of range.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TransferFunction.srgb_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.srgb_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">srgb_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sRGB electro-optical transfer function (sRGB gamma to linear sRGB)</span>

<span class="sd">        :param im: sRGB image tensor </span>
<span class="sd">        :return: linear sRGB image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">/</span> <span class="mf">12.92</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="n">im</span> <span class="o">+</span> <span class="mf">0.055</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.055</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="mf">0.04045</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.srgb_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.srgb_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">srgb_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sRGB opto-electronic transfer function (linear sRGB to sRGB gamma)</span>

<span class="sd">        :param im: linear sRGB image tensor </span>
<span class="sd">        :return: sRGB image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">*</span> <span class="mf">12.92</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.055</span> <span class="o">-</span> <span class="mf">0.055</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="mf">0.0031308</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.rec709_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.rec709_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rec709_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rec. 709 electro-optical transfer function (Rec. 709 gamma to linear sRGB)</span>

<span class="sd">        :param im: Rec. 709 image tensor </span>
<span class="sd">        :return: linear sRGB image tensor (same primaries)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">/</span> <span class="mf">4.5</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="n">im</span> <span class="o">+</span> <span class="mf">0.099</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.099</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="mf">0.081</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.rec709_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.rec709_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rec709_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rec. 709 opto-electronic transfer function (linear sRGB to Rec. 709 gamma)</span>

<span class="sd">        :param im: linear sRGB image tensor (same primaries)</span>
<span class="sd">        :return: Rec. 709 image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">*</span> <span class="mf">4.5</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.099</span> <span class="o">-</span> <span class="mf">0.099</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="mf">0.018</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.rec2020_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.rec2020_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rec2020_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rec. 2020 electro-optical transfer function (Rec. 2020 gamma to linear)</span>

<span class="sd">        :param im: Rec. 2020 image tensor </span>
<span class="sd">        :return: linear Rec. 2020 gamut image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">1.09929682680944</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.08124285829</span>     
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">/</span> <span class="mf">4.5</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="n">im</span> <span class="o">+</span> <span class="n">a</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">a</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span> <span class="mf">0.45</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.rec2020_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.rec2020_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rec2020_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rec. 2020 opto-electronic transfer function (linear to Rec. 2020 gamma)</span>

<span class="sd">        :param im: linear Rec. 2020 gamut image tensor </span>
<span class="sd">        :return: Rec. 2020 image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">1.09929682680944</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.018053968510807</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">im</span> <span class="o">*</span> <span class="mf">4.5</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mf">.45</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">im</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.dcip3_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.dcip3_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dcip3_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DCI P3 electro-optical transfer function (DCI P3 gamma to linear)</span>

<span class="sd">        :param im: DCI P3 image tensor </span>
<span class="sd">        :return: linear P3 gamut image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="mf">2.6</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">im</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.dcip3_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.dcip3_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dcip3_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DCI P3 opto-electronic transfer function (linear to DCI P3 gamma)</span>

<span class="sd">        :param im: linear P3 gamut image tensor </span>
<span class="sd">        :return: DCI P3 image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">im</span><span class="p">),</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">2.6</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">im</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransferFunction.log_c_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.log_c_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_c_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LogC electro-optical transfer function</span>

<span class="sd">        :param im: LogC encoded image tensor</span>
<span class="sd">        :return: linear image tensor </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.00937677</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.1496582</span><span class="p">,</span> 
            <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.385537</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.2471896</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.18</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mf">0.9661776</span> <span class="o">-</span> <span class="mf">0.04378604</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.18</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="TransferFunction.log_c_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.log_c_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">log_c_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LogC opto-electronic transfer function</span>

<span class="sd">        :param im: linear image tensor </span>
<span class="sd">        :return: LogC encoded image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mf">0.00937677</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
            <span class="p">(((</span><span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.18</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.2471896</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.385537</span><span class="p">),</span>
            <span class="p">((((</span><span class="n">x</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.18</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.04378604</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9661776</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="TransferFunction.s_log_eotf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.s_log_eotf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">s_log_eotf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        S-Log electro-optical transfer function</span>

<span class="sd">        :param im: S-Log encoded image tensor</span>
<span class="sd">        :return: linear image tensor </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="p">((</span><span class="n">im</span> <span class="o">-</span> <span class="mf">0.616596</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.432699</span><span class="p">))</span> <span class="o">-</span> <span class="mf">0.037584</span></div>

<div class="viewcode-block" id="TransferFunction.s_log_oetf"><a class="viewcode-back" href="../../source/tinycio.html#tinycio.TransferFunction.s_log_oetf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">s_log_oetf</span><span class="p">(</span><span class="n">im</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        S-Log opto-electronic transfer function</span>

<span class="sd">        :param im: linear image tensor </span>
<span class="sd">        :return: S-Log encoded image tensor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">0.432699</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">im</span> <span class="o">+</span> <span class="mf">0.037584</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.616596</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.03</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>